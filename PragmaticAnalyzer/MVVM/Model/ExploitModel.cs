using PragmaticAnalyzer.Configs;
using PragmaticAnalyzer.Databases;
using System.Collections.ObjectModel;
using System.Net.Http;

namespace PragmaticAnalyzer.MVVM.Model
{
    public class ExploitModel
    {
        private readonly HttpClient _httpClient;
        private event Action<string> MessageChanged;
        private readonly ExploitConfig _config;

        public ExploitModel(Action<string> messageChanged, ExploitConfig exploitConfig)
        {
            MessageChanged += messageChanged;
            _config = exploitConfig;
            var handler = new HttpClientHandler
            {
                ClientCertificateOptions = ClientCertificateOption.Manual,
                ServerCertificateCustomValidationCallback =
            (httpRequestMessage, cert, cetChain, policyErrors) => { return true; }
            };
            _httpClient = new HttpClient(handler)
            {
                Timeout = TimeSpan.FromSeconds(30),
            };
            _httpClient.DefaultRequestHeaders.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36");
            _httpClient.DefaultRequestHeaders.Add("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8");
            _httpClient.DefaultRequestHeaders.Add("Accept-Language", "en-US,en;q=0.5");

        }

       /* public async Task<ObservableCollection<Exploit>> GetDatabase()
        {
            MessageChanged?.Invoke("Модуль парсинга запущен");

            int counter = _config.StartPoint;
            if (counter is not 0)
            {
                MessageChanged?.Invoke($"Продолжение парсинга с {counter} записи");
            }

            ObservableCollection<Exploit> database = [];
            var rnd = new Random();
            HtmlWeb web = new();

            while (true)
            {
                if (cancellationRequested())
                {
                    MessageChanged?.Invoke("Модуль парсинга принудительно остановлен");
                    _config.StartPoint = counter;
                    break;
                }

                if (counter % 5 is 0)
                {
                    var stopValue = rnd.Next(5000, 10000);
                    MessageChanged?.Invoke($"Приостановлено на {stopValue / 1000} сек.");
                    await Task.Delay(stopValue);
                }

                var exploitVdbUrl = _config.ExploitUrlVdb + $"exploits/{counter}";
                var exploitVulnersUrl = _config.ExploitUrlVulners + counter;

                MessageChanged?.Invoke($"Обращение к {exploitVdbUrl}");

                var exploitVdbResponse = await _httpClient.GetAsync(exploitVdbUrl);
                var exploitVulnersResponse = await _httpClient.GetAsync(exploitVulnersUrl);
                if ((int)exploitVdbResponse.StatusCode is 404 || (int)exploitVulnersResponse.StatusCode is 404)
                {
                    MessageChanged?.Invoke($"Запись {counter} не существует");
                    counter++;
                    continue;
                }
                exploitVdbResponse.EnsureSuccessStatusCode();
                exploitVulnersResponse.EnsureSuccessStatusCode();

                var htmlVbd = await exploitVdbResponse.Content.ReadAsStringAsync();
                var htmlVulners = await exploitVulnersResponse.Content.ReadAsStringAsync();

                HtmlDocument docVbd = new();
                HtmlDocument docVulners = new();
                docVbd.LoadHtml(htmlVbd);
                docVulners.LoadHtml(htmlVulners);

                var name = docVbd.DocumentNode.SelectSingleNode("//h1[contains(@class,'card-title')]")?.InnerText.Trim();
                if (name is "404")
                {
                    MessageChanged?.Invoke("Конец выполнения");
                    _config.StartPoint = counter;
                    break;
                }

                var downloadUrl = _config.ExploitUrlVdb + $"download/{counter}";
                MessageChanged?.Invoke($"Обращение к {downloadUrl}");
                using HttpResponseMessage downloadResponse = await _httpClient.GetAsync(downloadUrl);

                var statusCode = (int)downloadResponse.StatusCode;
                if (statusCode is 429 or 403)
                {
                    MessageChanged?.Invoke("Работа приостановлена на 5 минут");
                    await Task.Delay(300000);
                    continue;
                }

                using var stream = await downloadResponse.Content.ReadAsStreamAsync();
                using var fileStream = File.Create(Path.Combine(filePath, $"{counter}.txt"));
                await stream.CopyToAsync(fileStream);


                var id = docVbd.DocumentNode.SelectSingleNode("(//h6[contains(@class,'stats-title')])[1]")?.InnerText.Trim();
                var cve = docVbd.DocumentNode.SelectSingleNode("//a[contains(@href, '/vuln/detail/CVE-')]")?.InnerText.Trim();
                var description = docVulners.DocumentNode.SelectSingleNode("//*[contains(@class, 'Description-root')]//p")?.InnerText.Trim();
                var author = docVbd.DocumentNode.SelectSingleNode("(//div[contains(@class,'col-6 text-center')]/h6/a)[2]")?.InnerText.Trim();
                var type = docVbd.DocumentNode.SelectSingleNode("//a[contains(@href, 'type=')]")?.InnerText.Trim();
                var platform = docVbd.DocumentNode.SelectSingleNode("//a[starts-with(@href, '/?platform=')]")?.InnerText.Trim();
                var datePublication = docVbd.DocumentNode.SelectSingleNode("(//div[contains(@class,'col-6 text-center')]/h6/a)[1]")?.InnerText.Trim();

                var nCol6A = docVbd.DocumentNode.SelectSingleNode("(//div[contains(@class,'col-6 text-center')]/h6/a)[n]")?.InnerText.Trim(); //что это
                database.Add(new()
                {
                    Id = id,
                    Name = name,
                    Cve = cve,
                    Description = description,
                    Author = author,
                    Type = type,
                    Platform = platform,
                    DatePublication = datePublication,
                });

                MessageChanged?.Invoke($"Добавлена запись {counter}");

                counter++;
            }
            _config.StartPoint = counter;
            return database;
        }*/
    }
}